<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=0.7">

<title>Prescription Summary – Kiara Optometry</title>

<style>

body *:not(h1):not(h2):not(h3):not(h4):not(h5):not(h6) {
  font-size:14px !important;
}

body{
  margin:0; padding:0;
  font-family:"Inter","Helvetica Neue",Arial;
  background:#fff;
}
#report-container{
  width:90%; max-width:580px;
  margin:20px auto 80px auto;
  padding-bottom:40px;
}
.section{
  background:#fdfcf7;
  margin-bottom:20px; padding:20px 18px;
  border-radius:14px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.header-section{ text-align:center; background:#ffffeb; }
.logo{ width:90px; margin-bottom:10px; }
.title{ margin:0; font-size:26px; font-weight:300; }
#exam-datetime{ margin-top:6px; font-size:13px; opacity:.8; }
#rx-toggle-wrapper{ margin-top:14px; }
.toggle-label{ font-size:13px; margin-right:8px; }
.toggle-btn{
  padding:6px 12px;
  border:1px solid black;
  background:black;          /* ACTIVE */
  color:white;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
  font-weight:300;
  margin-right:6px;
}
.toggle-btn.inactive{
  background:#fff; color:black;
}
h2{
  font-size:22px; font-weight:300;
}
h3{
font-size:17px; font-weight:300;
}
.subhead{
  font-size:15px; font-weight:300;
  margin-top:15px; margin-bottom:6px;
}
#patient-details,
#current-rx,
#add-details,
#final-rx-section,
#patient-weartype,
#final-rx,
#final-notes,
#final-analysis,
#final-analysis-sph,
#final-analysis-cylax,
#extra-notes {
  line-height: 1.3;
  font-size: 14px;
  font-weight: 300;
}

}
.image-placeholder{
  background:#fffbd2; padding:40px 10px;
  border-radius:12px; text-align:center;
  margin-bottom:14px; font-size:13px; font-weight:300;
  color:#555; border:1px dashed #c8c08a;
}
.footer-section{text-align:center; padding:20px;}
.qr-placeholder{
  background:#fffbd2; border:1px dashed #c8c08a;
  padding:40px 10px; border-radius:12px;
  font-size:13px; margin-bottom:15px;
}
.info{
  font-size:13px;
  line-height:1.3;
  color:#2b2b2b;
  letter-spacing:0.4px;
  font-weight:300;
}

.disclaimer{ font-size:11px; opacity:.7; }
.footer-brand{margin-top:10px; font-size:13px; font-weight:300;}
/* PDF button also converted */
.pdf-button{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  padding:12px 22px;
  background:black;
  color:white;
  border:none;
  border-radius:8px;
  font-size:14px;
  font-weight:300;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
.cl-line { font-size:14px; color:#333; }


</style>
</head>

<body>

<div id="report-container">


    <div id="rx-toggle-wrapper">
      <span class="toggle-label">Show:</span>
      <button class="toggle-btn" id="toggle-comfy">Comfy Clearer RX</button>
      <button class="toggle-btn inactive" id="toggle-manual">Manual RX</button>
    </div>


<!-- PATIENT HEADING -->
<div style="height:20px"></div>
<div class="section" id="patient-current-section">
  <h2 style="margin-top:10px" id="patient-name-h2"></h2>
    <div id="exam-datetime"></div>

</div>


<!-- CURRENT PRESCRIPTION -->
<div class="section" id="patient-current-section">
  <h2>Current Prescription</h2>

  <div id="patient-subdetails"
       style="font-size:14px;">
  </div>

  <div id="current-rx" style="margin-top:10px;"></div>
  <div id="add-details" style="margin-top:10px;"></div>



<div style="height:20px"></div>
<h2>Short & Long Sighted Test</h2>

<div id="exam-images-duo" style="text-align:center; margin-bottom:20px;">
  <div id="exam-duochrome-details"
       style="text-align:left"> </div>



<div style="width:100%; overflow:hidden; border:1px solid lightgrey; border-radius:12px; text-align:center; background:#fff;">
  <img id="exam-duochrome"
       src=""
       style="width:100%; display:block; margin-top:-15px; margin-bottom:-40px; transform: scale(0.95); transform-origin: center center; margin-left:-10px">
</div>






<div style="height:10px"></div>

<div style="width:100%; background:#fff; display:flex; justify-content:center; overflow:hidden; border:1px solid lightgrey; border-radius:12px; margin-bottom:20px;">
  <img src="https://raw.githubusercontent.com/kiaraoptometrypx/RX-calculator/main/DC%20Defect/Defects_type.png" 
       style="width:80%; margin-bottom:0px; margin-top:0px; display:block;">
</div>




</div>

<div style="height:10px"></div>

<h2>Astigmatism Test</h2>

<div id="exam-images-fan" style="text-align:center; margin-bottom:20px;">
  <div id="exam-astig-details"
       style="font-size:14px; font-weight:300; line-height:1.55; margin-top:8px; text-align:left">
  </div>
  <div style="width:100%; overflow:hidden; border:1px solid lightgrey; border-radius:12px;">
    <img id="exam-fanchart"
         src=""
         style="width:100%; margin-top:-4px; margin-bottom:-20px; display:none;">
  </div>
<div style="height:10px"></div>

<div style="width:100%; background:#fff; display:flex; justify-content:center; overflow:hidden; border:1px solid lightgrey; border-radius:12px; margin-bottom:20px;">
  <img src="https://raw.githubusercontent.com/kiaraoptometrypx/RX-calculator/main/FC%20Defect/Defects_type.png" 
       style="width:80%; margin-bottom:0px; margin-top:0px; display:block;">
</div>
</div>

</div>


<!-- COMFY / MANUAL FINAL RX -->
<div class="section" id="final-rx-section">
  <h2 id="final-rx-title">New Prescription</h2>
<div id="patient-weartype"></div>

  <div id="final-rx"></div>
</div>


<!-- EXTRA NOTES -->
<div class="section" id="Summary">
  <h2>Summary</h2>
<div id="final-analysis"></div>
<div id="final-analysis-sph"></div>
<div id="final-analysis-cylax"></div>

</div>

<div class="section" id="extra-notes-section">
  <h2>Extra Notes</h2>
  <div id="final-notes"></div>
</div>


<!-- EDUCATION -->
<div class="section" id="education-section">
  <h2>Understanding Your Prescription</h2>
  <div id="education-content">
<p class="info"><i>Info : Short & long-sighted vision is measured using the duochrome chart. The clarity in the red and blue are compared. The correct prescription makes both side equal. The ideal prescription is when the clarity is slightly better in the blue; to be exact +0.25 to balance. </i></p>

<p class="info"><i>Info : Astigmatism is a condition; unequal power at different angles. This is due to certain parts of the eye is flatter than the other. The Fan Chart is used to measure the differences in clarity. The correct prescription makes all lines equal. </i></p>

<p style="text-align:left;" class="info"><i>Info : Prescription is the measurement of the eyeball size and shape. A normal eye measures about 22–24.5 mm, while a zero-power eye is around 23.5 mm (0.25 D is about 0.09 mm). Prescription rarely changes after the age of 20, which is in tandem with developmental years.</i></p>

  </div>
</div>


<!-- FOOTER -->
<div class="section footer-section">
  <div class="qr-placeholder">[ WhatsApp QR Placeholder ]</div>
  <p class="disclaimer">This summary is for personal understanding only.</p>
  <p class="footer-brand">Kiara Optometry</p>
</div>

<button id="downloadPDF" class="pdf-button">Download PDF</button>

</div>


















<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function fmt(v){
  if(v===""||v==null) return "";
  let n=parseFloat(v);
  if(isNaN(n)) return v;
  return (n>=0?"+":"") + n.toFixed(2);
}
const data = JSON.parse(localStorage.getItem("rxReport") || "{}");



/* ==============================
   PATIENT H2 + DATE/TIME
============================== */
(function(){
  const fullName = `${data.suffix || ""} ${data.name || ""}`.trim();
  const age = data.age || "";

  if (!fullName) return;

  const now = new Date();
  const day = now.getDate();
  const month = now.toLocaleString("en-GB",{month:"short"});
  const year = now.getFullYear();
  const suffix =
    day % 10 === 1 && day !== 11 ? "st" :
    day % 10 === 2 && day !== 12 ? "nd" :
    day % 10 === 3 && day !== 13 ? "rd" : "th";
  const time = now.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});
  const dateTime = `${day}${suffix} ${month} ${year} · ${time}`;

  document.getElementById("exam-datetime").textContent = dateTime;
  document.getElementById("patient-name-h2").innerHTML = `${fullName} · Age ${age}`;
})();

/* ==============================
   WEAR TYPE
============================== */
(function(){
  const wear = data.wearType || "";
  const wearCap = wear ? wear.charAt(0).toUpperCase() + wear.slice(1) : "";
  document.getElementById("patient-weartype").innerHTML =
    wearCap ? `RX Type: ${wearCap}` : "";
})();

/* ==============================
   CURRENT RX
============================== */
(function(){
  const wear = data.wearType || "";
  const wearCap = wear ? wear.charAt(0).toUpperCase() + wear.slice(1) : "";
const fmtVal = v => v || "—";
document.getElementById("current-rx").innerHTML = `
  <div style="font-size:11px;">
    <div><b>RX type :</b> ${wearCap || "—"}</div>

<div style="display:flex; justify-content:space-between; max-width:350px; margin:5px 0 5px 0; font-size:11px;">
  <div style="font-size:11px;"><b>Right :</b> ${fmtVal(data.s1_od)} ${fmtVal(data.c1_od)} × ${fmtVal(data.a1_od)}</div>
  <div style="font-size:11px;"><b>Left :</b> ${fmtVal(data.s1_os)} ${fmtVal(data.c1_os)} × ${fmtVal(data.a1_os)}</div>
</div>


    <div style="font-size:11px;">Right SE ${fmtVal(data.nowSeDiff)} vs Left SE</div>
  </div>
`;

})();

/* ==============================
   ADD DETAILS
============================== */
(function(){
  document.getElementById("add-details").innerHTML =
    data.add_ou ? `<div><b>Current ADD:</b> ${data.add_ou}</div>` : "";
})();




/* ==============================
   EXAMINATION SECTION
============================== */
(function(){
  const DC_BASE = "https://raw.githubusercontent.com/kiaraoptometrypx/RX-calculator/main/DC%20Defect/";
  const FC_BASE = "https://raw.githubusercontent.com/kiaraoptometrypx/RX-calculator/main/FC%20Defect/";

  const DC_MAP = {
    red:   DC_BASE + "Red.png",
    green: DC_BASE + "Green.png",
    same:  DC_BASE + "Same.png",
  };

  function nearestAxisImg(axisVal){
    if (isNaN(axisVal)) return "";
    let shifted = axisVal + 90;
    if (shifted > 180) shifted -= 180;

    const angles = [15,30,45,60,75,90,105,120,135,150,165,180];
    const closest = angles.reduce((a,b)=>
      Math.abs(b-shifted) < Math.abs(a-shifted) ? b : a
    );

    return FC_BASE + closest + ".png";
  }

  // === NEW: Bal.png logic for c2_ou ===
  function getBalImg(c2_ou){
    const v = parseFloat(c2_ou);
    if (isNaN(v) || v === 0) return FC_BASE + "Bal.png";
    return "";
  }
  // ====================================

  const dcVal = fmt(data["dc-sph-ou"]);
  const axisVal = parseFloat(data["a2-ou"] || NaN);
  const c2ou = data.c2_ou;

  let dcImg = DC_MAP.same;
  if (!isNaN(dcVal)){
    if (dcVal > 0) dcImg = DC_MAP.green;
    else if (dcVal < 0) dcImg = DC_MAP.red;
  }

  // --- Fan Chart image decision ---
  let fcImg = "";
  const balImg = getBalImg(c2ou);    // auto Bal.png check first

  if (balImg){
    fcImg = balImg;
  } else if (!isNaN(axisVal)) {
    fcImg = nearestAxisImg(axisVal);
  }

let analysisText = "";
if (!isNaN(dcVal)) {
  if (Math.abs(dcVal - 0.25) < 0.01) {
    analysisText = `is good; with slight preference for far. Needs ${fmt(dcVal)} to balance.`;
  } else if (dcVal > 0) {
    analysisText = `is slightly strong. Needs ${fmt(dcVal)} to balance.`;
  } else if (dcVal < 0) {
    analysisText = `is slightly weak. Needs ${fmt(dcVal)} to balance.`;
  } else {
    analysisText = `is good; with slight preference for near. Needs ${fmt(dcVal)} to balance.`;
  }
}



  // --- Duochrome ---
  document.getElementById("exam-duochrome-details").innerHTML = `
    <div><h3>Your current RX ${analysisText}</h3></div>
  `;

// --- Astigmatism ---
let axisText = "—";

// c2ou already available
const cylVal = parseFloat(c2ou);

if (isNaN(axisVal)) {
  axisText = "—";
} else {
  if (isNaN(cylVal) || cylVal === 0) {
    axisText = `
      is equal and optimum at all angles.
    `;
  } else {
    axisText = `
      is biased at ${axisVal}°.
      Needs ${c2ou} to balance.
    `;
  }
}

document.getElementById("exam-astig-details").innerHTML = `
  <div><h3>Your current vision ${axisText}</h3></div>
`;


  const imgDuo = document.getElementById("exam-duochrome");
  imgDuo.src = dcImg;
  imgDuo.style.display = "block";

  const imgFan = document.getElementById("exam-fanchart");
  imgFan.src = fcImg;
  imgFan.style.display = "block";
})();







/* =========================
   CONTACT LENS CONVERTER
========================= */
const CL_CYL_STEPS=[-0.75,-1.25,-1.75,-2.25,-2.75];

function glassesToCL(F){ const d=0.009; return F/(1 - d*F); }
function r025(x){
  return Math.round(x * 4) / 4;
}function roundUp025(x){ return Math.ceil(x/0.25)*0.25; }
function nearest(arr,val){ return arr.reduce((b,v)=>Math.abs(v-val)<Math.abs(b-val)?v:b,arr[0]); }

function flatterAxis(a){
  a = parseFloat(a) || 0;
  if (a <= 0) a = 180;
  const R = Math.round(a / 10) * 10;
  return R > 180 ? 180 : R;
}

function convertToCL(S, C, A) {
  S = parseFloat(S) || 0;
  C = parseFloat(C) || 0;
  A = parseFloat(A) || 0;

  const total = S + C;
  const convS = glassesToCL(S);
  const convT = glassesToCL(total);
  const rawCyl = convT - convS;

  const cylRounded = nearest(CL_CYL_STEPS, rawCyl);
  const sphereRounded = r025(convS);  // ← FIXED

  const axisRounded = flatterAxis(A);

if (Math.abs(rawCyl) < 0.375){
    const SE = r025(convS + rawCyl/2);
    return { S: SE, C: 0, A: null };
}


  const diff = rawCyl - cylRounded;
  const correctedSphere = r025(sphereRounded + diff/2); // ← FIXED

  return {
    S: correctedSphere,
    C: cylRounded,
    A: axisRounded
  };
}



/* ==============================
   COMFY / MANUAL FINAL RX
============================== */
const btnComfy = document.getElementById("toggle-comfy");
const btnManual = document.getElementById("toggle-manual");
const titleFinal = document.getElementById("final-rx-title");
const finalRX = document.getElementById("final-rx");
const finalNotes = document.getElementById("final-notes");
const finalAnalysis      = document.getElementById("final-analysis");
const finalAnalysisSph   = document.getElementById("final-analysis-sph");
const finalAnalysisCylAx = document.getElementById("final-analysis-cylax");


function loadComfy(){
  titleFinal.textContent = "New Prescription";

  const fmtPlus = v => (v > 0 ? "+" + v.toFixed(2) : v.toFixed(2));

  const rSph = parseFloat(data.comfyR?.sph) || 0;
  const lSph = parseFloat(data.comfyL?.sph) || 0;

  const rCyl = parseFloat(data.comfyR?.cyl) || 0;
  const lCyl = parseFloat(data.comfyL?.cyl) || 0;

  const rAxis = parseFloat(data.comfyR?.axis) || 0;
  const lAxis = parseFloat(data.comfyL?.axis) || 0;

  const rDist = rSph - 0.25,  lDist = lSph - 0.25;
  const rComp = rSph + 0.50,  lComp = lSph + 0.50;

  const rCL_bal  = convertToCL(rSph,  rCyl, rAxis);
  const lCL_bal  = convertToCL(lSph,  lCyl, lAxis);

  const rCL_dist = convertToCL(rDist, rCyl, rAxis);
  const lCL_dist = convertToCL(lDist, lCyl, lAxis);

  const rCL_comp = convertToCL(rComp, rCyl, rAxis);
  const lCL_comp = convertToCL(lComp, lCyl, lAxis);


  // === RX HTML ===
  finalRX.innerHTML = `
<div style="max-width:450px; line-height:1.3;">

  <!-- A -->
  <div><b>A. Balanced Vision :</b></div>
  <div style="display:flex; justify-content:space-between; gap:8px; margin:6px 0 14px 0;">
    <div style="width:85px;">
      <b>Spectacles</b><br>
      <span class="cl-line"><b>Contact Lens</b></span>
    </div>

    <div>
      <b>Right :</b> ${fmtPlus(rSph)} ${fmtPlus(rCyl)} × ${rAxis}<br>
      <span class="cl-line">
        Right : ${fmtPlus(rCL_bal.S)} ${rCL_bal.C ? fmtPlus(rCL_bal.C) + " × " + rCL_bal.A : ""}
      </span>
    </div>

    <div>
      <b>Left :</b> ${fmtPlus(lSph)} ${fmtPlus(lCyl)} × ${lAxis}<br>
      <span class="cl-line">
        Left : ${fmtPlus(lCL_bal.S)} ${lCL_bal.C ? fmtPlus(lCL_bal.C) + " × " + lCL_bal.A : ""}
      </span>
    </div>
  </div>

  <!-- B -->
  <div><b>B. Distance Preferred :</b></div>
  <div style="display:flex; justify-content:space-between; gap:8px; margin:6px 0 14px 0;">
    <div style="width:85px;">
      <b>Spectacles</b><br>
      <span class="cl-line"><b>Contact Lens</b></span>
    </div>

    <div>
      <b>Right :</b> ${fmtPlus(rDist)} ${fmtPlus(rCyl)} × ${rAxis}<br>
      <span class="cl-line">
        Right : ${fmtPlus(rCL_dist.S)} ${rCL_dist.C ? fmtPlus(rCL_dist.C) + " × " + rCL_dist.A : ""}
      </span>
    </div>

    <div>
      <b>Left :</b> ${fmtPlus(lDist)} ${fmtPlus(lCyl)} × ${lAxis}<br>
      <span class="cl-line">
        Left : ${fmtPlus(lCL_dist.S)} ${lCL_dist.C ? fmtPlus(lCL_dist.C) + " × " + lCL_dist.A : ""}
      </span>
    </div>
  </div>

  <!-- C -->
  <div><b>C. Laptop / Computer (+0.50) :</b></div>
  <div style="display:flex; justify-content:space-between; gap:8px; margin:6px 0 0px 0;">
    <div style="width:85px;">
      <b>Spectacles</b><br>
      <span class="cl-line"><b>Contact Lens</b></span>
    </div>

    <div>
      <b>Right :</b> ${fmtPlus(rComp)} ${fmtPlus(rCyl)} × ${rAxis}<br>
      <span class="cl-line">
        Right : ${fmtPlus(rCL_comp.S)} ${rCL_comp.C ? fmtPlus(rCL_comp.C) + " × " + rCL_comp.A : ""}
      </span>
    </div>

    <div>
      <b>Left :</b> ${fmtPlus(lComp)} ${fmtPlus(lCyl)} × ${lAxis}<br>
      <span class="cl-line">
        Left : ${fmtPlus(lCL_comp.S)} ${lCL_comp.C ? fmtPlus(lCL_comp.C) + " × " + lCL_comp.A : ""}
      </span>
    </div>
  </div>

</div>

<br>

<div><b>Bino Difference Right VS Left Eye :</b> SE ${data.comfySeDiff || "—"}</div>
`;


  // === ANALYSIS — standardized 100% same style ===
  finalNotes.textContent = data.comfyNotes || "—";

  finalAnalysis.innerHTML =
    data.comfyAnalysis?.replace(/\n/g,"<br>") || "—";

  finalAnalysisSph.innerHTML =
    data.comfyAnalysisSph?.replace(/\n/g,"<br>") || "—";

  finalAnalysisCylAx.innerHTML =
    data.comfyAnalysisCylAx?.replace(/\n/g,"<br>") || "—";


  btnComfy.classList.remove("inactive");
  btnManual.classList.add("inactive");
}



/* =======================
     MANUAL MODE
======================= */
function loadManual(){
  titleFinal.textContent = "Manual Prescription";
  finalRX.innerHTML = `
<div><b>Right:</b> ${data.manualR?.sph} ${data.manualR?.cyl} × ${data.manualR?.axis} (${data.manualR?.dc})</div>
<div><b>Left:</b> ${data.manualL?.sph} ${data.manualL?.cyl} × ${data.manualL?.axis} (${data.manualL?.dc})</div>
`;

  finalNotes.textContent = data.manualNotes || "—";
  finalAnalysis.textContent = "—";

  btnManual.classList.remove("inactive");
  btnComfy.classList.add("inactive");
}


/* =======================
    INITIAL LOAD
======================= */
loadComfy();
btnComfy.onclick = loadComfy;
btnManual.onclick = loadManual;



/* EXTRA NOTES */
(function(){
  document.getElementById("extra-notes").innerHTML =
    (data.extraNotes || "").replace(/\n/g,"<br>");
})();


/* PDF DOWNLOAD */
document.getElementById("downloadPDF").onclick = async () => {
  const el = document.getElementById("report-container");
  const canvas = await html2canvas(el,{scale:2,useCORS:true});
  const img = canvas.toDataURL("image/png");
  const pdf = new jspdf.jsPDF({
    orientation:"p", unit:"px", format:[canvas.width, canvas.height]
  });
  pdf.addImage(img,"PNG",0,0,canvas.width,canvas.height);
  pdf.save("Prescription-Summary.pdf");
};
</script>

</body>
</html>
